<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hapi | 森林土豆</title>
    <meta name="description" content="人间熙攘，好久不见">
    <link rel="icon" href="/img/logo.ico">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/img/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.af295b8d.css" as="style"><link rel="preload" href="/assets/js/app.0cb9bcd2.js" as="script"><link rel="preload" href="/assets/js/10.bfbd47bf.js" as="script"><link rel="prefetch" href="/assets/js/11.bc18f3c2.js"><link rel="prefetch" href="/assets/js/12.05d40827.js"><link rel="prefetch" href="/assets/js/13.60ac598c.js"><link rel="prefetch" href="/assets/js/14.191595c8.js"><link rel="prefetch" href="/assets/js/15.0e2c24f1.js"><link rel="prefetch" href="/assets/js/16.bcd27ce7.js"><link rel="prefetch" href="/assets/js/17.7cb7eefa.js"><link rel="prefetch" href="/assets/js/18.360eb27c.js"><link rel="prefetch" href="/assets/js/19.15a49fa6.js"><link rel="prefetch" href="/assets/js/2.d9868d83.js"><link rel="prefetch" href="/assets/js/20.c8b044be.js"><link rel="prefetch" href="/assets/js/21.8fdf0606.js"><link rel="prefetch" href="/assets/js/22.a971e6ba.js"><link rel="prefetch" href="/assets/js/23.fb462429.js"><link rel="prefetch" href="/assets/js/3.b1b0f3a8.js"><link rel="prefetch" href="/assets/js/4.d4a6abc0.js"><link rel="prefetch" href="/assets/js/5.8f5e346b.js"><link rel="prefetch" href="/assets/js/6.7e4c57cb.js"><link rel="prefetch" href="/assets/js/7.34df8046.js"><link rel="prefetch" href="/assets/js/8.823fd0ac.js"><link rel="prefetch" href="/assets/js/9.ec040553.js">
    <link rel="stylesheet" href="/assets/css/0.styles.af295b8d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">森林土豆</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/JavaScript/ES6的一些方法和技巧.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/Blog/GIT/git的一些总结.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/Blog/Node/node版本管理.html" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/Blog/MiniPrograms/MiniPrograms.html" class="nav-link">MiniPrograms</a></li><li class="dropdown-item"><!----> <a href="/Blog/VUE/vue.html" class="nav-link">VUE</a></li><li class="dropdown-item"><!----> <a href="/Blog/WebpackFile/webpack.html" class="nav-link">Webpack</a></li><li class="dropdown-item"><!----> <a href="/Blog/Other/gulp.html" class="nav-link">Other</a></li></ul></div></div> <a href="https://github.com/magicLaLa/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/JavaScript/ES6的一些方法和技巧.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/Blog/GIT/git的一些总结.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/Blog/Node/node版本管理.html" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/Blog/MiniPrograms/MiniPrograms.html" class="nav-link">MiniPrograms</a></li><li class="dropdown-item"><!----> <a href="/Blog/VUE/vue.html" class="nav-link">VUE</a></li><li class="dropdown-item"><!----> <a href="/Blog/WebpackFile/webpack.html" class="nav-link">Webpack</a></li><li class="dropdown-item"><!----> <a href="/Blog/Other/gulp.html" class="nav-link">Other</a></li></ul></div></div> <a href="https://github.com/magicLaLa/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Node</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/Blog/Node/node版本管理.html" class="sidebar-link">node版本管理</a></li><li><a href="/Blog/Node/npm.html" class="sidebar-link">npm 镜像设置</a></li><li><a href="/Blog/Node/mySQL.html" class="sidebar-link">MySQL</a></li><li><a href="/Blog/Node/hapi.html" class="active sidebar-link">Hapi</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Blog/Node/hapi.html#hapi-相关使用总结" class="sidebar-link">Hapi 相关使用总结</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>MiniPrograms</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>VUE</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Other</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="hapi"><a href="#hapi" aria-hidden="true" class="header-anchor">#</a> Hapi</h1> <h2 id="hapi-相关使用总结"><a href="#hapi-相关使用总结" aria-hidden="true" class="header-anchor">#</a> Hapi 相关使用总结</h2> <ul><li>Hapi.js 是一个用来构建基于 Node.js 的应用和服务的富框架，使得开发者把重点放在便携可重用的应用逻辑而不是构建架构。内建输入验证、缓存、认证和其他 Web 应用开发常用的功能。</li></ul> <h3 id="hapi-框架模块接口文档"><a href="#hapi-框架模块接口文档" aria-hidden="true" class="header-anchor">#</a> Hapi 框架模块接口文档</h3> <ul><li><a href="https://hapijs.com/" target="_blank" rel="noopener noreferrer">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://hapijs.com/api" target="_blank" rel="noopener noreferrer">Hapi-api<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="supervisor-nodemon-pm2"><a href="#supervisor-nodemon-pm2" aria-hidden="true" class="header-anchor">#</a> Supervisor / nodemon / PM2</h3> <ul><li>有不少 Node.js 小工具能帮助我们监视代码的改动然后自动重启 Node.js 服务，好用的工具有 <code>Supervisor / nodemon / PM2</code>。</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 系统全局安装 supervisor</span>
$ <span class="token function">npm</span> i -g supervisor
</code></pre></div><h3 id="目录结构"><a href="#目录结构" aria-hidden="true" class="header-anchor">#</a> 目录结构</h3> <div class="language- extra-class"><pre class="language-text"><code>├── config                       # 项目配置目录
|   ├── index.js                 # 配置项目中的配置信息
├── models                       # 数据库 model
├── node_modules                 # node.js 的依赖目录
├── plugins                      # 插件目录
├── routes                       # 路由目录
│   ├── hello-world.js           # 测试接口 hello-world
├── utils                        # 工具类相关目录
├── app.js                       # 项目入口文件
├── package.json                 # JS 项目工程依赖库
├── README.md                    # 项目工程如何被使用的说明手册
</code></pre></div><h3 id="环境配置"><a href="#环境配置" aria-hidden="true" class="header-anchor">#</a> 环境配置</h3> <ul><li>例子：</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># .env.example</span>

<span class="token comment"># 服务的启动名字和端口，但也可以缺省不填值，默认值的填写只是一定程度减少起始数据配置工作</span>
HOST <span class="token operator">=</span> 127.0.0.1
PORT <span class="token operator">=</span> 3000
</code></pre></div><h3 id="读取-env-中的配置值"><a href="#读取-env-中的配置值" aria-hidden="true" class="header-anchor">#</a> 读取 .env 中的配置值</h3> <ul><li>Node.js 可以通过 env2 的插件，来读取 .env 配置文件，加载后的环境配置参数，可以通过例如 process.env.PORT 来读取端口信息。</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i env2 -D
</code></pre></div><h3 id="使用-swagger-插件配置接口文档"><a href="#使用-swagger-插件配置接口文档" aria-hidden="true" class="header-anchor">#</a> 使用 Swagger 插件配置接口文档</h3> <h4 id="安装基础依赖与基础插件配置"><a href="#安装基础依赖与基础插件配置" aria-hidden="true" class="header-anchor">#</a> 安装基础依赖与基础插件配置</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 安装适配 hapi v16 的 swagger 插件</span>
<span class="token function">npm</span> i hapi-swagger@7
<span class="token function">npm</span> i inert@4
<span class="token function">npm</span> i vision@4
<span class="token function">npm</span> i package
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>├── plugins                       # hapi 插件配置
|   ├── hapi-swagger.js           # swagger 插件
</code></pre></div><ul><li>通过 <strong>自己的服务地址+/documentation</strong> 来查看 Swagger 文档。<em>http://192.168.31.10:8181/documentation</em></li></ul> <h3 id="使用-joi-校验数据结构"><a href="#使用-joi-校验数据结构" aria-hidden="true" class="header-anchor">#</a> 使用 Joi 校验数据结构</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 安装适配 hapi v16 的 joi 插件</span>
<span class="token function">npm</span> i joi@13
</code></pre></div><h3 id="mysql修改默认编码"><a href="#mysql修改默认编码" aria-hidden="true" class="header-anchor">#</a> MySQL修改默认编码</h3> <ul><li><code>show variables like '%char%';</code> 查看默认编码</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'%char%'</span><span class="token punctuation">;</span>
+--------------------------+---------------------------------------------------------+
<span class="token operator">|</span> Variable_name            <span class="token operator">|</span> Value                                                   <span class="token operator">|</span>
+--------------------------+---------------------------------------------------------+
<span class="token operator">|</span> character_set_client     <span class="token operator">|</span> gbk                                                     <span class="token operator">|</span>
<span class="token operator">|</span> character_set_connection <span class="token operator">|</span> gbk                                                     <span class="token operator">|</span>
<span class="token operator">|</span> character_set_database   <span class="token operator">|</span> utf8                                                    <span class="token operator">|</span>
<span class="token operator">|</span> character_set_filesystem <span class="token operator">|</span> binary                                                  <span class="token operator">|</span>
<span class="token operator">|</span> character_set_results    <span class="token operator">|</span> gbk                                                     <span class="token operator">|</span>
<span class="token operator">|</span> character_set_server     <span class="token operator">|</span> utf8                                                    <span class="token operator">|</span>
<span class="token operator">|</span> character_set_system     <span class="token operator">|</span> utf8                                                    <span class="token operator">|</span>
<span class="token operator">|</span> character_sets_dir       <span class="token operator">|</span> C:\Program Files\MySQL\MySQL Server 5.7\share\charsets\ <span class="token operator">|</span>
+--------------------------+---------------------------------------------------------+
8 rows <span class="token keyword">in</span> set, 1 warning <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>
</code></pre></div><ul><li><p>修改mysql编码，（version：5.7.24）Window10下 <code>my.ini</code>文件路径在 <code>C:\ProgramData\MySQL\MySQL Server 5.7\</code></p></li> <li><p>在my.ini添加如下：</p></li></ul> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token selector">[mysqld]</span>
<span class="token constant">character-set-server</span><span class="token attr-value"><span class="token punctuation">=</span>utf8</span>
<span class="token selector">[client]</span>
<span class="token constant">default-character-set</span><span class="token attr-value"><span class="token punctuation">=</span>utf8</span>
<span class="token selector">[mysql]</span>
<span class="token constant">default-character-set</span><span class="token attr-value"><span class="token punctuation">=</span>utf8</span>
</code></pre></div><h3 id="mysql-与-sequelize"><a href="#mysql-与-sequelize" aria-hidden="true" class="header-anchor">#</a> MySQL 与 Sequelize</h3> <ul><li>数据库为 MySQL 5.6。<a href="https://sequelize.readthedocs.io/en/v3/" target="_blank" rel="noopener noreferrer">Sequelize<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 则是 Node.js 生态中一款知名的基于 promise 数据库 ORM 插件，提供了大量常用数据库增删改查的函数式 API，以帮助我们在实际开发中，大量减少书写冗长的基础数据库查询语句。</li> <li>Sequelize 支持的数据库有：<code>PostgreSQL，MySQL，MariaDB，SQLite 和 MSSQL。</code>在使用不同的数据库时候，需要我们开发者额外安装不同的对应数据库连接驱动，d当前使用的 MySQL，则依赖于插件 MySQL2 。</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># MySQL 连接</span>
<span class="token punctuation">[</span>root@vultr ~<span class="token punctuation">]</span><span class="token comment"># mysql -u root -p</span>
Enter password: *******

Welcome to the MySQL monitor.  Commands end with <span class="token punctuation">;</span> or \g.
Your MySQL connection <span class="token function">id</span> is 3
Server version: 5.7.22 MySQL Community Server <span class="token punctuation">(</span>GPL<span class="token punctuation">)</span>

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> 2000, 2018, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

<span class="token comment"># 查看数据库编码格式</span>
mysql<span class="token operator">&gt;</span> show variables like <span class="token string">'%char%'</span><span class="token punctuation">;</span>
+--------------------------+---------------------------------------------------------+
<span class="token operator">|</span> Variable_name            <span class="token operator">|</span> Value                                                   <span class="token operator">|</span>
+--------------------------+---------------------------------------------------------+
<span class="token operator">|</span> character_set_client     <span class="token operator">|</span> utf8                                                    <span class="token operator">|</span>
<span class="token operator">|</span> character_set_connection <span class="token operator">|</span> utf8                                                    <span class="token operator">|</span>
<span class="token operator">|</span> character_set_database   <span class="token operator">|</span> latin1                                                  <span class="token operator">|</span>
<span class="token operator">|</span> character_set_filesystem <span class="token operator">|</span> binary                                                  <span class="token operator">|</span>
<span class="token operator">|</span> character_set_results    <span class="token operator">|</span> utf8                                                    <span class="token operator">|</span>
<span class="token operator">|</span> character_set_server     <span class="token operator">|</span> latin1                                                  <span class="token operator">|</span>
<span class="token operator">|</span> character_set_system     <span class="token operator">|</span> utf8                                                    <span class="token operator">|</span>
<span class="token operator">|</span> character_sets_dir       <span class="token operator">|</span> C:\Program Files\MySQL\MySQL Server 5.7\share\charsets\ <span class="token operator">|</span>
+--------------------------+---------------------------------------------------------+
8 rows <span class="token keyword">in</span> set, 1 warning <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>

<span class="token comment"># 创建用户</span>
<span class="token comment"># 说明：</span>
<span class="token comment"># username：你将创建的用户名</span>
<span class="token comment"># host：指定该用户在哪个主机上可以登陆，如果是本地用户可用localhost，如果想让该用户可以从任意远程主机登陆，可以使用通配符%</span>
<span class="token comment"># password：该用户的登陆密码，密码可以为空，如果为空则该用户可以不需要密码登陆服务器</span>
mysql<span class="token operator">&gt;</span> CREATE USER <span class="token string">'username'</span>@<span class="token string">'host'</span> IDENTIFIED BY <span class="token string">'password'</span><span class="token punctuation">;</span>

<span class="token comment"># 授权</span>
<span class="token comment"># 说明:</span>
<span class="token comment"># privileges：用户的操作权限，如SELECT，INSERT，UPDATE等，如果要授予所的权限则使用ALL</span>
<span class="token comment"># databasename：数据库名</span>
<span class="token comment"># tablename：表名，如果要授予该用户对所有数据库和表的相应操作权限则可用*表示，如*.*</span>
<span class="token comment"># 例子：</span>
<span class="token comment"># GRANT SELECT, INSERT ON test.user TO 'pig'@'%';</span>
<span class="token comment"># GRANT ALL ON *.* TO 'pig'@'%';</span>
mysql<span class="token operator">&gt;</span> GRANT privileges ON databasename.tablename TO <span class="token string">'username'</span>@<span class="token string">'host'</span><span class="token punctuation">;</span>
<span class="token comment"># 注意:用以上命令授权的用户不能给其它用户授权，如果想让该用户可以授权，用以下命令:</span>
mysql<span class="token operator">&gt;</span> GRANT privileges ON databasename.tablename TO <span class="token string">'username'</span>@<span class="token string">'host'</span> WITH GRANT OPTION<span class="token punctuation">;</span>

<span class="token comment"># 设置与更改用户密码</span>
mysql<span class="token operator">&gt;</span> SET PASSWORD FOR <span class="token string">'username'</span>@<span class="token string">'host'</span> <span class="token operator">=</span> PASSWORD<span class="token punctuation">(</span><span class="token string">'newpassword'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 如果是当前登陆用户用:</span>
mysql<span class="token operator">&gt;</span> SET PASSWORD <span class="token operator">=</span> PASSWORD<span class="token punctuation">(</span><span class="token string">&quot;newpassword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 撤销用户权限</span>
<span class="token comment"># 说明：说明:privilege, databasename, tablename：同授权部分</span>
<span class="token comment"># 注意：</span>
<span class="token comment"># 假如你在给用户'pig'@'%'授权的时候是这样的（或类似的）：GRANT SELECT ON test.user TO 'pig'@'%'，则在使用REVOKE SELECT ON *.* FROM 'pig'@'%';命令并不能撤销该用户对test数据库中user表的SELECT 操作。相反，如果授权使用的是GRANT SELECT ON *.* TO 'pig'@'%';则REVOKE SELECT ON test.user FROM 'pig'@'%';命令也不能撤销该用户对test数据库中user表的Select权限。</span>
<span class="token comment"># 具体信息可以用命令SHOW GRANTS FOR 'pig'@'%'; 查看</span>
mysql<span class="token operator">&gt;</span> REVOKE privilege ON databasename.tablename FROM <span class="token string">'username'</span>@<span class="token string">'host'</span><span class="token punctuation">;</span>

<span class="token comment"># 删除用户</span>
mysql<span class="token operator">&gt;</span> DROP USER <span class="token string">'username'</span>@<span class="token string">'host'</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="sequelize-cli"><a href="#sequelize-cli" aria-hidden="true" class="header-anchor">#</a> Sequelize-cli</h4> <ul><li><p>Sequelize 插件的主要应用场景是实际应用开发过程中的代码逻辑层。与其相伴的还有一套 cli 工具，Sequelize-cli，提供了一系列好用的终端指令，来帮助我们完成一些常用的琐碎任务。</p></li> <li><p>安装依赖</p></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i sequelize-cli -D
<span class="token function">npm</span> i sequelize
<span class="token function">npm</span> i mysql2
</code></pre></div><ul><li>sequelize init (通过 sequelize-cli 初始化 sequelize，我们将得到一个好用的初始化结构：)</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># windows下</span>
node_modules\.bin\sequelize init
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>├── config                       # 项目配置目录
|   ├── config.[json|js]              # 数据库连接的配置
├── models                       # 数据库 model
|   ├── index.js                 # 数据库连接的样板代码
├── migrations                   # 数据迁移的目录
├── seeders                      # 数据填充的目录
</code></pre></div><ul><li>sequelize db:create</li></ul> <p>执行下面的命令，可以默认使用 development 下的配置，来创建项目数据库。增加例如 --env production，则使用 config/config.js 中的 production 项配置，来完成数据库的创建。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>node_modules\.bin\sequelize db:create

<span class="token comment"># 通过 --env 参数，指定为生产环境创建项目数据库</span>
<span class="token comment"># node_modules\.bin\sequelize db:create --env production</span>
</code></pre></div><h3 id="migrate-数据迁移"><a href="#migrate-数据迁移" aria-hidden="true" class="header-anchor">#</a> migrate 数据迁移</h3> <ul><li>sequelize migration:create <em>使用 sequelize migration:create 来创建一个迁移文件 create-shops-table。</em></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>node_modules\.bin\sequelize migration:create --name create-shops-table
</code></pre></div><ul><li>sequelize db:migrate <em>帮助将 migrations 目录下的迁移行为定义，按时间戳的顺序，逐个地执行迁移描述，最终完成数据库表结构的自动化创建。并且，在数据库中会默认创建一个名为 SequelizeMeta 的表，用于记录在当前数据库上所运行的迁移历史版本。</em></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>node_modules\.bin\sequelize db:migrate
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> show tables<span class="token punctuation">;</span>
+---------------------+
<span class="token operator">|</span> Tables_in_practtest <span class="token operator">|</span>
+---------------------+
<span class="token operator">|</span> goods               <span class="token operator">|</span>
<span class="token operator">|</span> sequelizemeta       <span class="token operator">|</span>
<span class="token operator">|</span> shops               <span class="token operator">|</span>
+---------------------+
3 rows <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>
</code></pre></div><ul><li><p>sequelize db:migrate:undo <em>sequelize db:migrate:undo 则可以帮助我们按照 down 方法中所定义的规则，回退一个数据库表结构迁移的状态。<code>node_modules\.bin\sequelize db:migrate:undo</code></em></p></li> <li><p>向表中追加字段 <em>创建一个名叫 add-columns-to-shops-table 的迁移迁移文件：<code>node_modules\.bin\sequelize migration:create --name add-columns-to-shops-table</code></em></p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  up<span class="token punctuation">:</span> <span class="token punctuation">(</span>queryInterface<span class="token punctuation">,</span> Sequelize<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    queryInterface<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span><span class="token string">'shops'</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  down<span class="token punctuation">:</span> queryInterface <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    queryInterface<span class="token punctuation">.</span><span class="token function">removeColumn</span><span class="token punctuation">(</span><span class="token string">'shops'</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 之前的表结构</span>
mysql<span class="token operator">&gt;</span> desc shops<span class="token punctuation">;</span>
+------------+--------------+------+-----+---------+----------------+
<span class="token operator">|</span> Field      <span class="token operator">|</span> Type         <span class="token operator">|</span> Null <span class="token operator">|</span> Key <span class="token operator">|</span> Default <span class="token operator">|</span> Extra          <span class="token operator">|</span>
+------------+--------------+------+-----+---------+----------------+
<span class="token operator">|</span> <span class="token function">id</span>         <span class="token operator">|</span> int<span class="token punctuation">(</span>11<span class="token punctuation">)</span>      <span class="token operator">|</span> NO   <span class="token operator">|</span> PRI <span class="token operator">|</span> NULL    <span class="token operator">|</span> auto_increment <span class="token operator">|</span>
<span class="token operator">|</span> name       <span class="token operator">|</span> varchar<span class="token punctuation">(</span>255<span class="token punctuation">)</span> <span class="token operator">|</span> NO   <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> thumb_url  <span class="token operator">|</span> varchar<span class="token punctuation">(</span>255<span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> created_at <span class="token operator">|</span> datetime     <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> updated_at <span class="token operator">|</span> datetime     <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>                <span class="token operator">|</span>
+------------+--------------+------+-----+---------+----------------+
5 rows <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 再次运行完 node_modules\.bin\sequelize db:migrate 后的表结构</span>
mysql<span class="token operator">&gt;</span> desc shops<span class="token punctuation">;</span>
+------------+--------------+------+-----+---------+----------------+
<span class="token operator">|</span> Field      <span class="token operator">|</span> Type         <span class="token operator">|</span> Null <span class="token operator">|</span> Key <span class="token operator">|</span> Default <span class="token operator">|</span> Extra          <span class="token operator">|</span>
+------------+--------------+------+-----+---------+----------------+
<span class="token operator">|</span> <span class="token function">id</span>         <span class="token operator">|</span> int<span class="token punctuation">(</span>11<span class="token punctuation">)</span>      <span class="token operator">|</span> NO   <span class="token operator">|</span> PRI <span class="token operator">|</span> NULL    <span class="token operator">|</span> auto_increment <span class="token operator">|</span>
<span class="token operator">|</span> name       <span class="token operator">|</span> varchar<span class="token punctuation">(</span>255<span class="token punctuation">)</span> <span class="token operator">|</span> NO   <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> thumb_url  <span class="token operator">|</span> varchar<span class="token punctuation">(</span>255<span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> created_at <span class="token operator">|</span> datetime     <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> updated_at <span class="token operator">|</span> datetime     <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> address    <span class="token operator">|</span> varchar<span class="token punctuation">(</span>255<span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> NULL    <span class="token operator">|</span>                <span class="token operator">|</span>
+------------+--------------+------+-----+---------+----------------+
6 rows <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>
</code></pre></div><h3 id="seeders-种子数据填充"><a href="#seeders-种子数据填充" aria-hidden="true" class="header-anchor">#</a> seeders 种子数据填充</h3> <ul><li><p>sequelize seed:create <em><code>node_modules\.bin\sequelize seed:create --name init-shops</code></em></p></li> <li><p>sequelize db:seed:all <em>与 db:migrate 相似，执行 sequelize db:seed:all ，将向数据库填充 seeders 目录中所有 up 方法所定义的数据。<code>node_modules\.bin\sequelize db:seed:all</code></em><strong>注意: seeders 的执行，不会将状态存储在 SequelizeMeta 表中。</strong>(当然，我们也可以通过 <code>--seed</code> 来制定特定的 <code>seed</code> 配置来做填充：
<code>node_modules\.bin\sequelize db:seed --seed 20190103082032-init-goods.js</code>)</p></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 添加后的数据表</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from shops<span class="token punctuation">;</span>
+----+-------+-----------+---------------------+---------------------+---------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> name  <span class="token operator">|</span> thumb_url <span class="token operator">|</span> created_at          <span class="token operator">|</span> updated_at          <span class="token operator">|</span> address <span class="token operator">|</span>
+----+-------+-----------+---------------------+---------------------+---------+
<span class="token operator">|</span>  1 <span class="token operator">|</span> 店铺1 <span class="token operator">|</span> 1.png     <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> NULL    <span class="token operator">|</span>
<span class="token operator">|</span>  2 <span class="token operator">|</span> 店铺2 <span class="token operator">|</span> 2.png     <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> NULL    <span class="token operator">|</span>
<span class="token operator">|</span>  3 <span class="token operator">|</span> 店铺3 <span class="token operator">|</span> 3.png     <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> NULL    <span class="token operator">|</span>
<span class="token operator">|</span>  4 <span class="token operator">|</span> 店铺4 <span class="token operator">|</span> 4.png     <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> NULL    <span class="token operator">|</span>
<span class="token operator">|</span>  5 <span class="token operator">|</span> 店铺5 <span class="token operator">|</span> 5.png     <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> NULL    <span class="token operator">|</span>
+----+-------+-----------+---------------------+---------------------+---------+
5 rows <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>
</code></pre></div><ul><li>sequelize db:seed:undo <em>Seeders 所填充的数据，也与迁移的 db:migrate:undo 相仿，只是不会进入 SequelizeMeta 记录。两个可用的命令如下，很简单，不再赘述：</em></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>
<span class="token comment"># 撤销所有的种子</span>
node_modules\.bin\sequelize db:seed:undo:all
<span class="token comment"># 数据表</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from shops<span class="token punctuation">;</span>
+----+-------+-----------+---------------------+---------------------+---------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> name  <span class="token operator">|</span> thumb_url <span class="token operator">|</span> created_at          <span class="token operator">|</span> updated_at          <span class="token operator">|</span> address <span class="token operator">|</span>
+----+-------+-----------+---------------------+---------------------+---------+
<span class="token operator">|</span>  5 <span class="token operator">|</span> 店铺5 <span class="token operator">|</span> 5.png     <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> 2018-12-30 12:10:22 <span class="token operator">|</span> NULL    <span class="token operator">|</span>
+----+-------+-----------+---------------------+---------------------+---------+
1 row <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>

<span class="token comment"># 撤销指定的种子</span>
node_modules\.bin\sequelize db:seed:undo --seed XXXXXXXXXXXXXX-demo-user.js
</code></pre></div><h3 id="sequelize-连接-mysql-数据库"><a href="#sequelize-连接-mysql-数据库" aria-hidden="true" class="header-anchor">#</a> Sequelize 连接 MySQL 数据库</h3> <ul><li>Sequelize 连接数据库的核心代码主要就是通过 new Sequelize（database, username, password, options） 来实现，其中 options 中的配置选项，除了最基础的 host 与 port、数据库类型外，还可以设置连接池的连接参数 pool，数据模型命名规范 underscored 等等。具体可以查阅官方手册 <a href="http://docs.sequelizejs.com/manual/installation/usage.html" target="_blank" rel="noopener noreferrer">基础使用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。<strong>希望遵循 MySQL 数据库表字段的下划线命名规范，所以，需要全局开启一个 <code>underscore: true</code> 的定义，来使系统中默认的 createdAt 与 updatedAt 能以下划线的方式，与表结构保持一致。</strong></li></ul> <h4 id="定义数据库业务相关的-model"><a href="#定义数据库业务相关的-model" aria-hidden="true" class="header-anchor">#</a> 定义数据库业务相关的 model</h4> <ul><li>结合业务所需，可以在存放 models 目录下继续创建一系列的 model 来与数据库表结构做对应：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>├── models                       # 数据库 model
│   ├── index.js                 # model 入口与连接
│   ├── goods.js                 # 商品表
│   ├── shops.js                 # 店铺表
</code></pre></div><h4 id="实现接口"><a href="#实现接口" aria-hidden="true" class="header-anchor">#</a> 实现接口</h4> <ul><li>很多时候，我们并不希望 findAll 来将数据表中的所有数据全都暴露出来，比如在查询用户列表时，用户的密码的值，便是特别敏感的数据。 我们可以在 findAll 中加入一个 <code>attributes</code> 的约束，可以是一个要查询的属性（字段）列表，或者是一个 key 为 <code>include</code> 或 <code>exclude</code> 对象的键，比如对于用户表，<code>findAll({ attributes: { exclude: ['password'] } })</code>，就可以排除密码字段的查询露出。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Joi <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'joi'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> models <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token constant">GROUP_NAME</span> <span class="token operator">=</span> <span class="token string">'shops'</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">GROUP_NAME</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    handler<span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> reply<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 查找数据</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> models<span class="token punctuation">.</span>shops<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 只返回 id 和 name</span>
        attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token function">reply</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    config<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      tags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'api'</span><span class="token punctuation">,</span> <span class="token constant">GROUP_NAME</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      description<span class="token punctuation">:</span> <span class="token string">'获取店铺列表'</span><span class="token punctuation">,</span>
      <span class="token comment">// 适用于 GET 接口的 query（URL 路径参数）</span>
      validate<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        query<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          limit<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'每页条数'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token comment">// error(new Error('页码数不能为0！'))  显示的错误信息为中文（message）</span>
          page<span class="token punctuation">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'页码数'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'页码数不能为0！'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">]</span>
</code></pre></div><ul><li>列表分页 <code>options</code> 的具体配置参数细节说明，参见 <a href="https://github.com/fknop/hapi-pagination/tree/v1.6.5" target="_blank" rel="noopener noreferrer">hapi-pagination<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 安装适配 hapi v16 的 hapi-pagination</span>
$ <span class="token function">npm</span> i hapi-pagination@1
</code></pre></div><h3 id="基于-jwt-的身份验证"><a href="#基于-jwt-的身份验证" aria-hidden="true" class="header-anchor">#</a> 基于 JWT 的身份验证</h3> <ul><li>JWT 全称 JSON Web Token，是为了方便在各系统之间安全地传送 JSON 对象格式的信息，而采用的一个开发标准，基于 RFC 7519 定义。服务器在接收到 JWT 之后，可以验证它的合法性，用户登录与否的身份验证便是 JWT 的使用场景之一。</li> <li>JWT 具有「紧凑」与「自包含」的两大特点: 紧凑（compact）、自包含（self-contained）</li> <li>JWT 的构成---JSON Web Token 由 header、payload、signature 三部分组成，使用点号 . 分隔，下面是一段典型的 JWT 串:</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># header</span>
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
<span class="token comment"># payload</span>
eyJ1c2VySWQiOjEsImV4cCI6MTUzNTMyMjc0NSwiaWF0IjoxNTM0NzE3OTQ1fQ.
<span class="token comment"># signature</span>
6tOdn2R82bxJbXjAnwU5g4g9EKqGNe-qo4qCo6UZnQ
</code></pre></div><ul><li>header -- JWT 第一部分 header 指定了该 JWT 使用的签名算法：</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span> <span class="token property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;typ&quot;</span><span class="token operator">:</span><span class="token string">&quot;JWT&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><ul><li>payload -- JWT 的第二部分 <code>payload</code> 包含了该 JWT 的签发内容信息。以如上述 JWT 串为例，被解码之后，可以得到如下信息，包涵有用户 <code>ID</code>，<code>JWT</code> 过期时间 <code>exp</code>，<code>JWT</code> 签发时间 <code>iat</code>。</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;userId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1535322745</span><span class="token punctuation">,</span>
  <span class="token property">&quot;iat&quot;</span><span class="token operator">:</span> <span class="token number">1534717945</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中 JWT 的规范有一套预设的标准注册声明，非必要项，在业务场景需要的时候加入：</p> <blockquote><ul><li><code>iss(issuer)</code>：JWT 的签发者</li> <li><code>sub(subject)</code>：JWT 所面向的用户</li> <li><code>aud(audience)</code>：接收 JWT 的一方</li> <li><code>exp(expiresIn)</code>：JWT 的过期时间，这个时间必须大于签发时间</li> <li><code>nbf(notBefore)</code>：定义在什么时间之前，该 JWT 都是不可用的</li> <li><code>iat(issuedAt)</code>：JWT 的签发时间</li> <li><code>jti(jwtid)</code>：JWT 的唯一身份标识，主要用来作为一次性 token，从而避免重放攻击</li></ul></blockquote> <p>其他的信息数据，可以在 payload 中额外追加，避免与预设保留字冲突就好。<br> <em>注意</em> ：对于已签发的 JWT, 尽管信息是可以受到下文 signature 的签名防篡改保护，但 payload 部分的内容，依旧任何人都可以 decode 解码阅读。故而不要在 payload 中存放诸如密码密秘类的安全敏感数据。</p> <ul><li>signature -- JWT 的第三部分 signature 用来验证签发数据的合法性，是否存在第三方篡改伪造行为。由 header + payload + 签发 secret 组合而成。有心的读者可以发现，其中的参数条件 header 和 payload 皆为 base64 的编码内容，base64 是一种可双向的编码算法，所以不具备数据安全性。唯有 secret 的参数条件，在 JWT 最终的生成串中并不公开，所以在服务端保管好 secret 的签发字符串的私密性尤为重要，随意地将其提交进 git 的代码版本库，是一种极度不严谨行为。 以 HS256 算法为例，signature 的签发算法如下：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">HMACSHA256</span><span class="token punctuation">(</span><span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
</code></pre></div><p><code>Secret</code> 的秘钥签发，可以通过一些在线的 AES 加密工具来生成一串长度 32 或 64 的随机字符串。比如： <a href="http://tool.oschina.net/encrypt/" target="_blank" rel="noopener noreferrer">tool.oschina.net/encrypt/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。太长的字符串会一定程度上影响 jwt 验证的计算效率，所以找寻一个平衡点为宜。</p> <h4 id="基于-jwt-的身份验证的好处"><a href="#基于-jwt-的身份验证的好处" aria-hidden="true" class="header-anchor">#</a> 基于 JWT 的身份验证的好处</h4> <ul><li><strong>跨语言性</strong>：payload 数据结构基于 JSON，可以被任何主流语言支持。</li> <li><strong>免疫 CSRF</strong>：对 Cookie 的不依赖性，决定了天然免疫 CSRF 攻击。</li> <li><strong>可跨域性</strong>：同样是对 Cookie 的不依赖性，决定了更好的跨域支持与独立服务化属性。</li> <li><strong>多端适配</strong>：iOS， Android，微信小程序等非网页客户端，Cookie 是不被支持的，JWT 的认证机制则会简单很多。</li> <li><strong>去耦可扩展性</strong>：JWT 可以在任何拥有正确 secret 私钥的 API 服务环境被身份验证和使用，便于微服务拆分。</li></ul> <h4 id="基于-jwt-身份验证的注意项"><a href="#基于-jwt-身份验证的注意项" aria-hidden="true" class="header-anchor">#</a> 基于 JWT 身份验证的注意项</h4> <ul><li>不要在 JWT 的 payload 中签入敏感信息</li> <li>保护好 secret 秘钥</li> <li>使用 HTTPS 传输 JWT</li> <li>设置较短的 JWT 失效时间，并结合一个失效较长的 JWT RefreshToken 组合为宜。因为 JWT 无法轻易失效已签发的合法 JWT</li></ul> <h4 id="使用-jsonwebtoken-签发-jwt"><a href="#使用-jsonwebtoken-签发-jwt" aria-hidden="true" class="header-anchor">#</a> 使用 jsonwebtoken 签发 JWT</h4> <ul><li>jsonwebtoken 是 Node.js 生态里用于签发与校验 JWT 的流行插件。</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i jsonwebtoken
</code></pre></div><h5 id="jwt-sign-签发"><a href="#jwt-sign-签发" aria-hidden="true" class="header-anchor">#</a> jwt.sign 签发</h5> <ul><li>JWT 的签发语法是 <code>jwt.sign(payload, secretOrPrivateKey, [options, callback])</code>。默认的签发算法基于 <code>HS256 (HMAC SHA256)</code>，可以在 options 参数的 <code>algorithm</code> 另行修改。JWT 签发规范中的一些标准保留字段比如 <code>exp</code>，<code>nbf</code>，<code>aud</code>，<code>sub</code>，<code>iss</code> 等都没有默认值，可以一并在 <code>payload</code>参数中按需声明使用，亦可以在第三个参数 options 中，通过 <code>expiresIn</code>，<code>notBefore</code>，<code>audience</code>，<code>subject</code>，<code>issuer</code> 来分别赋值，但是不允许在两处同时声明。</li> <li>可以通过 <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JWT<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来 decode JWT 中的 payload 信息。</li></ul> <h5 id="hapi-auth-jwt2-接口用户验证"><a href="#hapi-auth-jwt2-接口用户验证" aria-hidden="true" class="header-anchor">#</a> hapi-auth-jwt2 接口用户验证</h5> <ul><li>安装</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i hapi-auth-jwt2@7
</code></pre></div><ul><li>hapi-auth-jwt2 配置</li></ul> <div class="language- extra-class"><pre class="language-text"><code>├── plugins                       # hapi 插件配置
│ ├── hapi-auth-jwt2.js           # jwt 配置插件
</code></pre></div><h3 id="sequelize-支持两种使用事务的方法"><a href="#sequelize-支持两种使用事务的方法" aria-hidden="true" class="header-anchor">#</a> Sequelize 支持两种使用事务的方法</h3> <ul><li>托管事务</li> <li>非托管事务</li></ul> <blockquote><p><em>在一个事务中，可能会包含开始（start）、提交（commit）、回滚（rollback）等操作，Sequelize 通过 <a href="http://docs.sequelizejs.com/manual/tutorial/transactions.html" target="_blank" rel="noopener noreferrer">Transaction<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>类来实现事务相关功能。以满足一些对操作过程的完整性比较高的使用场景。</em> <em>托管事务基于 Promise 结果链进行自动提交或回滚。非托管事务则交由用户自行控制提交或回滚。</em></p></blockquote> <h3 id="微信接收的数据与返回的格式都是以-text-xml-的格式，而非-application-json-，需要引入-xml2js-的插件帮助在-javascript-的-ojbect-与-xml-的-object-数据关系之间快速转换"><a href="#微信接收的数据与返回的格式都是以-text-xml-的格式，而非-application-json-，需要引入-xml2js-的插件帮助在-javascript-的-ojbect-与-xml-的-object-数据关系之间快速转换" aria-hidden="true" class="header-anchor">#</a> 微信接收的数据与返回的格式都是以 text/xml 的格式，而非 application/json ，需要引入 xml2js 的插件帮助在 JavaScript 的 Ojbect 与 XML 的 Object 数据关系之间快速转换</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i xml2js
</code></pre></div><h3 id="系统监控与记录-——-使用-good-插件"><a href="#系统监控与记录-——-使用-good-插件" aria-hidden="true" class="header-anchor">#</a> 系统监控与记录 —— 使用 Good 插件</h3> <ul><li>Good 是一个 hapi 插件，用于监视和报告来自主机的各种 hapi 服务器事件以及 ops 信息。它侦听 hapi 服务器实例发出的事件，并将标准化事件推送到流集合中。Good 插件目前有这四个扩展功能： good-squeeze、good-console、good-file、good-http。</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i good@7
<span class="token function">npm</span> i good-squeeze@5
<span class="token function">npm</span> i good-console@7
<span class="token function">npm</span> i good-file@6
<span class="token function">npm</span> i good-http@6
</code></pre></div><ul><li>good-squeeze：good-squeeze 是一个小转换流的集合。它提供了两个类，Squeeze 和 SafeJson, Squeeze 流基于良好的事件选项来过滤事件。SafeJson 流用于把对象转成 JSON 字符串，并且可以防止对象中循环引用引起的错误。</li> <li>good-console：good-console 能够将服务 good 服务事件转化为格式化字符串的转换流插件，最终通过 stdout 在控制台打印输出。</li></ul> <blockquote><p>GoodConsole([config])
good-console 本身提供 3 个参数来简单配置控制台的打印信息：</p> <ul><li>format：使用 MomentJS 格式化时间， 默认值 YYMMDD/HHmmss.SSS</li> <li>utc：boolean 输出时间是否为布尔值， 默认值 true</li> <li>color：boolean 是否彩色输出，默认值 true</li></ul></blockquote> <ul><li>good-file：基于 good-console 的控制台输出日志，当遇到控制台断开或是重启的时候，历史日志将无法找回，此时，在本地生成一份写文件的日志记录，会更好地便于日后的追溯。good-file 插件很好地解决了这样的需求痛点。</li></ul> <blockquote><p>GoodFile (path, options)</p> <ul><li>path：必填项，用来定义日志的写入目录</li> <li>options：选填项，文件流的选项。 默认值为<code>{ encoding: 'utf8', flags: 'a', mode: 0o666 }</code></li></ul></blockquote> <ul><li>good-http：除此之外，在实际应用场景中，我们会遇到一些高危异常的错误情况，这类日志我们更希望能在错误发生的第一时间，就通过自动报警的方式，来通知开发人员及时介入响应。这里可以使用 good-http 插件，它可以构造一个 post 的请求接口，将定义的重要日志信息以 JSON 的数据结构方式，推送到目标端点。</li></ul> <blockquote><p>GoodHttp (endpoint, config)</p> <ul><li>endpoint：日志发送的目标地址</li> <li>config：Object 类型的配置项目</li></ul></blockquote> <ul><li>组合使用日志插件：在实际项目使用中，可以进行组合性配置，在 reporters 字段中使用不同的 key 来区分即可</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>reporters<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  typeConsole<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// good-console 的一系列配置</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  typeFile<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// good-file 的一系列配置</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  typeHttpA<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// good-http 针对 A 平台的一系列配置</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  typeHttpB<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// good-http 针对 B 平台的一系列配置</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="使用-good-http-结合-sentry-自动收集错误日志"><a href="#使用-good-http-结合-sentry-自动收集错误日志" aria-hidden="true" class="header-anchor">#</a> 使用 good-http 结合 Sentry 自动收集错误日志</h3> <h4 id="sentry-简介"><a href="#sentry-简介" aria-hidden="true" class="header-anchor">#</a> Sentry 简介</h4> <p>Sentry 中文翻译过来是哨兵的意思，从字面中可以知道 「站岗、放哨、巡逻、稽查的士兵」，不错，Sentry 是程序的「哨兵」 。它可以监控我们在生产环境中项目的运行状态，一旦某段代码运行报错，或者异常，会第一时间把报错的 路由，异常文件，请求方式 等一些非常详细的信息以消息或者邮件给我们，让我们第一时间知道：程序出错了，然后我们可以从 Sentry 给我们的详细的错误信息中瞬间找到我们需要处理的代码，并及时修正。</p> <h4 id="sentry-服务搭建流程"><a href="#sentry-服务搭建流程" aria-hidden="true" class="header-anchor">#</a> Sentry 服务搭建流程</h4> <p>利用 hapi 的 API 服务能力再搭建一个简易的内网 API 服务，该服务使用 Sentry 的 raven 插件进行错误日志的收集与汇报，日志的信息源来自应用服务的 good-http 插件</p> <ul><li>申请 Sentry 的 API key</li> <li>配置 Sentry 的错误收集与报告插件 raven</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i raven
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Raven <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'raven'</span><span class="token punctuation">)</span>
Raven<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string">'https://your-sentry-api-key@sentry.io/182062'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>提供错误日志接收服务</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  path<span class="token punctuation">:</span> <span class="token string">'/reportErrorLog'</span><span class="token punctuation">,</span>
  handler<span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> reply<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//直接将请求参数上报到 Sentry</span>
    Raven<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>payload<span class="token punctuation">)</span>
    <span class="token function">reply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  config<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    tags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'api'</span><span class="token punctuation">,</span> <span class="token string">'report'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    auth<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>配置应用服务中 good-http 的错误日志推送到上述含有 Sentry raven 的 API 微服务</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>server<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  plugin<span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'good'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ops<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      interval<span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    reporters<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      typeHttp<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          module<span class="token punctuation">:</span> <span class="token string">'good-squeeze'</span><span class="token punctuation">,</span>
          name<span class="token punctuation">:</span> <span class="token string">'Squeeze'</span><span class="token punctuation">,</span>
          args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">'*'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          module<span class="token punctuation">:</span> <span class="token string">'good-http'</span><span class="token punctuation">,</span>
          args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'http://your-sentry-server/reportErrorLog'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Blog/Node/mySQL.html" class="prev">
          MySQL
        </a></span> <span class="next"><a href="/Blog/MiniPrograms/MiniPrograms.html">
          小程序相关
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.0cb9bcd2.js" defer></script><script src="/assets/js/10.bfbd47bf.js" defer></script>
  </body>
</html>
